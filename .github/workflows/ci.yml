name: CI

on:
  push:
    branches:
      - main
      - 'feature/*'
      - experiment
  pull_request:
    branches:
      - main

jobs:
  # Quick smoke test on latest Python/Ubuntu
  quick-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        
    - name: Run quick integration tests
      run: |
        pytest -v tests/integration/test_integration.py tests/integration/test_integration_additional.py

  # Full matrix testing across Python versions, OS, and numpy versions
  test-matrix:
    needs: quick-test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
        numpy-version: ['<2.0', '>=2.0']
        exclude:
          # numpy 2.0 requires Python 3.9+, already satisfied
          # Skip some combinations to reduce CI time
          - os: windows-latest
            python-version: '3.9'
          - os: macos-latest
            python-version: '3.9'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install OpenMP (macOS)
      if: runner.os == 'macOS'
      run: brew install libomp

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies with numpy ${{ matrix.numpy-version }}
      run: |
        python -m pip install --upgrade pip
        pip install "numpy${{ matrix.numpy-version }}"
        pip install -e ".[dev]"
        
    - name: Verify numpy version
      run: |
        python -c "import numpy; print(f'NumPy version: {numpy.__version__}')"
        
    - name: Run full test suite
      run: |
        pytest -v tests/

    - name: Test package import
      run: |
        python -c "from automl_tool.automl import AutoML; print('Import successful')"

  # Test installation methods
  test-install:
    needs: quick-test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Test pip install from source
      run: |
        python -m pip install --upgrade pip
        pip install .
        python -c "from automl_tool.automl import AutoML; print('Standard install successful')"

    - name: Test editable install
      run: |
        pip uninstall -y automl-tool
        pip install -e .
        python -c "from automl_tool.automl import AutoML; print('Editable install successful')"